@model HospitalManagementSystem.Models.Appointment
@inject IHttpContextAccessor HttpContextAccessor 
@* Inject to access session for role check *@

@{
    ViewData["Title"] = "Book New Appointment";

    // Get the user's role from session
    var role = HttpContextAccessor.HttpContext?.Session.GetString("Role");

    // Dynamically set the layout based on the user's role
    if (role == "Patient")
    {
        Layout = "~/Views/Shared/_Layout.Patient.cshtml";
    }
    else // Default for Admin, Doctor, or unauthenticated users
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
}

<h2 class="mb-4 text-center">📅 Book New Appointment</h2>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm p-4">
            <div class="card-body">
                <form asp-action="Create">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    @* Patient Selection - Only if Admin is booking, or pre-filled for Patient *@
                    @if (Context.Session != null && Context.Session.GetString("Role") == "Admin") 
                    {
                        <div class="form-group mb-3">
                            <label asp-for="PatientId" class="control-label">Patient</label>
                            <select asp-for="PatientId" class="form-control" asp-items="@(new SelectList(ViewBag.Patients, "Value", "Text"))">
                                <option value="">-- Select Patient --</option>
                            </select>
                            <span asp-validation-for="PatientId" class="text-danger"></span>
                        </div>
                    }
                    else if (Context.Session != null && Context.Session.GetString("Role") == "Patient")
                    {
                        <!-- Hidden input for PatientId if current user is a patient -->
                        <input type="hidden" asp-for="PatientId" value="@(Context.Session.GetInt32("PatientId") ?? 0)" /> 
                        <p class="mb-3">Booking for: <strong>@(Context.Session.GetString("Username") ?? "Guest User")</strong></p>
                    }

                    <div class="form-group mb-3">
                        <label asp-for="DoctorId" class="control-label">Doctor</label>
                        <select id="doctorSelect" asp-for="DoctorId" class="form-control" asp-items="@(new SelectList(ViewBag.Doctors, "Value", "Text"))">
                            <option value="">-- Select Doctor --</option>
                        </select>
                        <span asp-validation-for="DoctorId" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label for="appointmentDate" class="control-label">Appointment Date</label>
                        <input type="date" id="appointmentDate" name="AppointmentDateTime_Date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="AppointmentDateTime" class="text-danger"></span> 
                    </div>

                    <div class="form-group mb-3">
                        <label for="availableSlots" class="control-label">Available Time Slots</label>
                        <select id="availableSlots" name="AppointmentDateTime_Time" class="form-control" disabled>
                            <option value="">-- Select Date and Doctor --</option>
                        </select>
                        <span id="slotLoadingMessage" class="text-info d-none">Loading slots...</span>
                        <span class="text-danger" id="slotErrorMessage"></span>
                    </div>

                    @* Hidden field to combine date and time for model binding *@
                    <input type="hidden" asp-for="AppointmentDateTime" id="finalAppointmentDateTime" />


                    <div class="form-group mb-3">
                        <label asp-for="Reason" class="control-label">Reason for Appointment</label>
                        <textarea asp-for="Reason" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="Reason" class="text-danger"></span>
                    </div>

                   
                    
                    <div class="form-group d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-plus-circle me-2"></i> Book Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" crossorigin="anonymous"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            const doctorSelect = $('#doctorSelect');
            const appointmentDateInput = $('#appointmentDate');
            const availableSlotsSelect = $('#availableSlots');
            const slotLoadingMessage = $('#slotLoadingMessage');
            const slotErrorMessage = $('#slotErrorMessage');
            const finalAppointmentDateTime = $('#finalAppointmentDateTime');

            // Function to load available slots
            function loadAvailableSlots() {
                const doctorId = doctorSelect.val();
                const selectedDate = appointmentDateInput.val();

                // Clear previous slots and messages
                availableSlotsSelect.empty().append('<option value="">-- Loading Slots --</option>').prop('disabled', true);
                slotErrorMessage.text('').addClass('d-none');
                slotLoadingMessage.removeClass('d-none');

                if (doctorId && selectedDate) {
                    $.ajax({
                        url: '@Url.Action("GetAvailableSlots", "Appointment")',
                        type: 'GET',
                        data: {
                            doctorId: doctorId,
                            selectedDate: selectedDate
                        },
                        success: function (response) {
                            slotLoadingMessage.addClass('d-none');
                            if (response.success && response.slots.length > 0) {
                                availableSlotsSelect.empty();
                                availableSlotsSelect.append('<option value="">-- Select Time Slot --</option>');
                                $.each(response.slots, function (index, slot) {
                                    // Split the time string (e.g., "09:00 AM") to get just the time part for the value
                                    const timeOnly = slot.split(' ')[0]; // "09:00"
                                    availableSlotsSelect.append($('<option></option>').val(timeOnly).text(slot));
                                });
                                availableSlotsSelect.prop('disabled', false);
                            } else {
                                availableSlotsSelect.empty().append('<option value="">-- No Slots Available --</option>');
                                slotErrorMessage.text(response.message || "No slots found for this date and doctor.").removeClass('d-none');
                            }
                        },
                        error: function (xhr, status, error) {
                            slotLoadingMessage.addClass('d-none');
                            availableSlotsSelect.empty().append('<option value="">-- Error Loading Slots --</option>');
                            slotErrorMessage.text('Error loading slots. Please try again.').removeClass('d-none');
                            console.error("AJAX Error:", status, error, xhr.responseText);
                        }
                    });
                } else {
                    slotLoadingMessage.addClass('d-none');
                    availableSlotsSelect.empty().append('<option value="">-- Select Doctor and Date --</option>');
                    availableSlotsSelect.prop('disabled', true);
                }
            }

            // Combine date and time before form submission
            $('form').on('submit', function () {
                const datePart = appointmentDateInput.val(); // "yyyy-MM-dd"
                const timePart = availableSlotsSelect.val(); // "HH:mm" (e.g., "09:00", "14:30")

                if (datePart && timePart) {
                    // Combine into a full datetime string for model binding
                    finalAppointmentDateTime.val(`${datePart}T${timePart}:00`); // e.g., "2025-06-11T14:30:00"
                } else {
                    // If no time slot is selected, prevent submission or show error
                    if (!timePart) {
                        alert("Please select an available time slot.");
                        return false; // Prevent form submission
                    }
                }
            });


            // Attach event listeners
            doctorSelect.on('change', loadAvailableSlots);
            appointmentDateInput.on('change', loadAvailableSlots);

            // Initial load if doctor/date are pre-selected (e.g., after a validation error)
            if (doctorSelect.val() && appointmentDateInput.val()) {
                loadAvailableSlots();
            }
        });
    </script>
}
