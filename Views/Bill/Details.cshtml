@model HospitalManagementSystem.Models.Bill
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Bill Details";

    var role = HttpContextAccessor.HttpContext?.Session.GetString("Role");
    var isPatient = (role == "Patient");
    var isDoctor = (role == "Doctor");
    var isAdmin = (role == "Admin");

    // Determine layout based on user role
    // This logic is typically handled by _ViewStart.cshtml globally.
    // Keeping it here provides a fallback if _ViewStart.cshtml is not applied or has issues.
    // If _ViewStart.cshtml is reliably setting the layout, this block can be removed.
    if (isPatient)
    {
        Layout = "~/Views/Shared/_Layout.Patient.cshtml";
    }
    else if (isDoctor)
    {
        Layout = "~/Views/Shared/_Layout.Doctor.cshtml";
    }
    else if (isAdmin)
    {
        Layout = "~/Views/Shared/_Layout.cshtml"; // Admin might use default layout
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml"; // Fallback for unauthenticated/other roles
    }

    // Uncomment this line to temporarily disable layouts for debugging rendering issues,
    // if you are still getting 404s after this fix.
    // Layout = null;
}

<h2 class="mb-4 text-center">🧾 Bill Details</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["InfoMessage"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["InfoMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm p-4">
            <div class="card-header bg-primary text-white text-center rounded-top-md">
                <h4>Bill #@Html.DisplayFor(model => model.BillId)</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Bill Date:</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.BillDate)</dd>

                    <dt class="col-sm-4">Patient Name:</dt>
                    <dd class="col-sm-8">
                        @if (Model.Patient != null)
                        {
                            <a asp-controller="Patient" asp-action="Details" asp-route-id="@Model.PatientId">@Html.DisplayFor(model => model.Patient.Name)</a>
                        }
                        else
                        {
                            <span>N/A (Patient ID: @Model.PatientId)</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Doctor (Billed By):</dt>
                    <dd class="col-sm-8">
                        @if (Model.Doctor != null)
                        {
                            <a asp-controller="Doctor" asp-action="Details" asp-route-id="@Model.DoctorId">@Html.DisplayFor(model => model.Doctor.Name) (@Html.DisplayFor(model => model.Doctor.Specialization))</a>
                        }
                        else if (Model.DoctorId.HasValue)
                        {
                            <span>N/A (Doctor ID: @Model.DoctorId)</span>
                        }
                        else
                        {
                            <span>Not Assigned</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Associated Appointment:</dt>
                    <dd class="col-sm-8">
                        @if (Model.Appointment != null)
                        {
                            <a asp-controller="Appointment" asp-action="Details" asp-route-id="@Model.AppointmentId">
                                @Model.Appointment.AppointmentDateTime.ToString("yyyy-MM-dd hh:mm tt") -
                                @(Model.Appointment.Patient != null ? Model.Appointment.Patient.Name : "N/A Patient") with
                                @(Model.Appointment.Doctor != null ? Model.Appointment.Doctor.Name : "N/A Doctor")
                            </a>
                            <br />
                            <small class="text-muted">Reason: @(string.IsNullOrEmpty(Model.Appointment.Reason) ? "N/A" : Model.Appointment.Reason)</small>
                        }
                        else
                        {
                            <span>N/A (Appointment ID: @Model.AppointmentId)</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Total Amount:</dt>
                    <dd class="col-sm-8 fs-5 fw-bold text-success">@Model.TotalAmount.ToString("C")</dd>

                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(Model.Status == "Paid" ? "bg-success" : Model.Status == "Pending" ? "bg-warning text-dark" : "bg-secondary")">
                            @Html.DisplayFor(model => model.Status)
                        </span>
                    </dd>

                    <dt class="col-sm-4">Notes:</dt>
                    <dd class="col-sm-8">@(string.IsNullOrEmpty(Model.Notes) ? "N/A" : Model.Notes)</dd>
                </dl>

                <hr class="my-4" />
                <h4>Bill Items</h4>
                @if (Model.BillItems != null && Model.BillItems.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Service/Item</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.BillItems)
                                {
                                    <tr>
                                        <td>@Html.DisplayFor(modelItem => item.ItemName)</td>
                                        <td class="text-end">@Html.DisplayFor(modelItem => item.Quantity)</td>
                                        <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                        <td class="text-end">@item.Amount.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="3" class="text-end fw-bold">Grand Total:</td>
                                    <td class="text-end fw-bold fs-5">@Model.TotalAmount.ToString("C")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No items found for this bill.</p>
                }
            </div>
            <div class="card-footer text-center">
                @if (isAdmin || (isDoctor && Model.Status == "Pending"))
                {
                    <a asp-action="Edit" asp-route-id="@Model.BillId" class="btn btn-warning me-2"><i class="fas fa-edit me-1"></i> Edit Bill</a>
                }
                @if (isAdmin || (isDoctor && Model.Status == "Pending"))
                {
                    if (Model.Status == "Pending")
                    {
                        <button type="button" class="btn btn-success me-2 mark-paid-btn" data-id="@Model.BillId"><i class="fas fa-check-circle me-1"></i> Mark as Paid</button>
                    }
                }
                @if (isAdmin)
                {
                    <button type="button" class="btn btn-danger delete-bill-btn" data-id="@Model.BillId"><i class="fas fa-trash-alt me-1"></i> Delete Bill</button>
                }

                @{
                    string backAction = "MyBills"; // Default for patient
                    string backController = "Bill";
                    if (isDoctor || isAdmin)
                    {
                        backAction = "Index"; // Doctor/Admin goes back to their general bill list
                    }
                }
                <a asp-action="@backAction" asp-controller="@backController" class="btn btn-secondary mt-2"><i class="fas fa-arrow-left me-1"></i> Back to Bills List</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this bill (ID: <span id="billIdToDelete"></span>)? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" crossorigin="anonymous"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            // Mark as Paid button functionality (from Details view)
            $('.mark-paid-btn').on('click', function () {
                const billId = $(this).data('id');
                if (confirm('Are you sure you want to mark this bill as PAID? This action cannot be undone.')) {
                    $.ajax({
                        url: '@Url.Action("MarkAsPaid", "Bill")',
                        type: 'POST',
                        data: { id: billId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                location.reload(); // Reload to reflect status change
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("AJAX Error:", status, error, xhr.responseText);
                            alert('An error occurred while marking the bill as paid. Please try again.');
                        }
                    });
                }
            });

            // Delete bill button functionality (Admin only, from Details view)
            $('.delete-bill-btn').on('click', function () {
                const billId = $(this).data('id');
                if (confirm('Are you sure you want to PERMANENTLY delete this bill and all its items? This action cannot be undone.')) {
                    $.ajax({
                        url: '@Url.Action("Delete", "Bill")',
                        type: 'POST',
                        data: { id: billId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                window.location.href = '@Url.Action("Index", "Bill")'; // Redirect to the bill index page after successful deletion
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("AJAX Error:", status, error, xhr.responseText);
                            alert('An error occurred while deleting the bill. Please try again.');
                        }
                    });
                }
            });

            // Delete Modal setup (Moved from the main Details.cshtml into Script section)
            var billIdToDelete = 0;
            $('#deleteModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Button that triggered the modal
                billIdToDelete = button.data('id'); // Extract info from data-* attributes
                var modal = $(this);
                modal.find('#billIdToDelete').text(billIdToDelete);
            });

            // Confirm Delete button click (Moved into Script section)
            $('#confirmDeleteBtn').on('click', function () {
                $('#deleteModal').modal('hide'); // Hide the modal first
                // Trigger the AJAX call for deletion as defined above
                $('.delete-bill-btn[data-id="' + billIdToDelete + '"]').click(); // Simulate click on the main delete button
            });
        });
    </script>
}
